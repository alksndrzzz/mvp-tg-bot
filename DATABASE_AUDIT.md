# –ê—É–¥–∏—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Supabase

## –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: 2024-12-19

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ —Ç–∞–±–ª–∏—Ü–∞ `locations`
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∞–±–ª–∏—Ü–∞ `locations` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤ –∫–æ–¥–µ (`lib/db.js`, `bot.js`), –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `locations` —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
```sql
CREATE TABLE public.locations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  driver_id UUID NOT NULL REFERENCES public.drivers(id) ON DELETE CASCADE,
  latitude NUMERIC(10, 8) NOT NULL,
  longitude NUMERIC(11, 8) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL
);
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_locations_driver_id` - –Ω–∞ `driver_id` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ª–æ–∫–∞—Ü–∏–π –ø–æ –≤–æ–¥–∏—Ç–µ–ª—é
- `idx_locations_created_at` - –Ω–∞ `created_at DESC` –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

**RLS:** –í–∫–ª—é—á–µ–Ω, –ø–æ–ª–∏—Ç–∏–∫–∞ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–∑–∂–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### –¢–∞–±–ª–∏—Ü–∞ `drivers`

**–ö–æ–ª–æ–Ω–∫–∏:**
- `id` (UUID, PK) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `name` (TEXT, NOT NULL) - –∏–º—è –≤–æ–¥–∏—Ç–µ–ª—è ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `token` (TEXT, NOT NULL, UNIQUE) - —Ç–æ–∫–µ–Ω –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `telegram_chat_id` (BIGINT, nullable) - ID —á–∞—Ç–∞ –≤ Telegram ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `is_active` (BOOLEAN, nullable, default: false) - –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `route_status` (TEXT, nullable, default: 'not-started-yet') - —Å—Ç–∞—Ç—É—Å –º–∞—Ä—à—Ä—É—Ç–∞ ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
  - CHECK: `route_status IN ('not-started-yet', 'in-progress', 'stopped')`
- `last_reminded_date` (DATE, nullable) - –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `reminder_start_date` (DATE, nullable) - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (legacy) ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ (fallback)
- `reminder_end_date` (DATE, nullable) - –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (legacy) ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ (fallback)
- `journey_start_date` (DATE, nullable) - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–µ–∑–¥–∫–∏ ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `journey_end_date` (DATE, nullable) - –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–µ–∑–¥–∫–∏ ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `created_at` (TIMESTAMPTZ, nullable, default: now()) - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `updated_at` (TIMESTAMPTZ, nullable, default: now()) - –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚ö†Ô∏è –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ (–Ω–æ –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏)
- `phone_number` (TEXT, nullable) - –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚ö†Ô∏è –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ –±–æ—Ç–∞

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- –ù–µ—Ç (—ç—Ç–æ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞)

**–°–≤—è–∑–∏:**
- `drivers.id` ‚Üê `locations.driver_id` (CASCADE DELETE)
- `drivers.id` ‚Üê `journey_notifications.driver_id` (CASCADE DELETE)

### –¢–∞–±–ª–∏—Ü–∞ `locations`

**–ö–æ–ª–æ–Ω–∫–∏:**
- `id` (UUID, PK) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `driver_id` (UUID, NOT NULL, FK ‚Üí drivers.id) - ID –≤–æ–¥–∏—Ç–µ–ª—è ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `latitude` (NUMERIC(10, 8), NOT NULL) - —à–∏—Ä–æ—Ç–∞ ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `longitude` (NUMERIC(11, 8), NOT NULL) - –¥–æ–ª–≥–æ—Ç–∞ ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `created_at` (TIMESTAMPTZ, NOT NULL, default: now()) - –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `captured_at` (TIMESTAMPTZ, NOT NULL, default: now()) - —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ, —á—Ç–æ–±—ã –≤–Ω–µ—à–Ω–∏–µ –≤—Å—Ç–∞–≤–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ –º–æ–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω–∏—è (–µ—Å–ª–∏ –≤—Å—Ç–∞–≤–∫–∞ –≤–Ω–µ —ç—Ç–æ–≥–æ —Ä–µ–ø–æ, –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —è–≤–Ω–æ –∏–ª–∏ –±–µ—Ä—ë—Ç DEFAULT now())

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- `driver_id` ‚Üí `drivers.id` (ON DELETE CASCADE) ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_locations_driver_id` - –Ω–∞ `driver_id` ‚úÖ —Å–æ–∑–¥–∞–Ω
- `idx_locations_created_at` - –Ω–∞ `created_at DESC` ‚úÖ —Å–æ–∑–¥–∞–Ω

**RLS:** –í–∫–ª—é—á–µ–Ω ‚úÖ

### –¢–∞–±–ª–∏—Ü–∞ `journey_notifications`

**–ö–æ–ª–æ–Ω–∫–∏:**
- `id` (UUID, PK) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `driver_id` (UUID, NOT NULL, FK ‚Üí drivers.id) - ID –≤–æ–¥–∏—Ç–µ–ª—è ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `notification_type` (TEXT, NOT NULL) - —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
  - CHECK: `notification_type IN ('ending_soon', 'ended')`
- `sent_at` (TIMESTAMPTZ, nullable, default: now()) - –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `created_at` (TIMESTAMPTZ, nullable, default: now()) - –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- `driver_id` ‚Üí `drivers.id` (ON DELETE CASCADE) ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–°–≤—è–∑–∏:**
- `journey_notifications.driver_id` ‚Üí `drivers.id` ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### –¢–∞–±–ª–∏—Ü–∞ `users`

**–ö–æ–ª–æ–Ω–∫–∏:**
- `id` (UUID, PK, FK ‚Üí auth.users.id) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `email` (TEXT, NOT NULL) - email –∞–¥—Ä–µ—Å
- `role` (TEXT, NOT NULL, default: 'user') - —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - CHECK: `role IN ('admin', 'user')`
- `timezone` (TEXT, nullable, default: 'Europe/Vilnius') - —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- `created_at` (TIMESTAMPTZ, NOT NULL, default: now())
- `updated_at` (TIMESTAMPTZ, NOT NULL, default: now())
- –î—Ä—É–≥–∏–µ –∫–æ–ª–æ–Ω–∫–∏ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –±–æ—Ç–µ)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –±–æ—Ç–µ:**
- `timezone` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∞–¥–º–∏–Ω–∞ (`getAdminTimezone()`)

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –≤ –∫–æ–¥–µ

### ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ë–î

**–¢–∞–±–ª–∏—Ü–∞ `drivers`:**
- ‚úÖ `id` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ
- ‚úÖ `name` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ `token` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π
- ‚úÖ `telegram_chat_id` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤—è–∑–∏ —Å Telegram
- ‚úÖ `is_active` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚úÖ `route_status` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–º –º–∞—Ä—à—Ä—É—Ç–∞
- ‚úÖ `last_reminded_date` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
- ‚úÖ `reminder_start_date` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback
- ‚úÖ `reminder_end_date` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback
- ‚úÖ `journey_start_date` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –ø–æ–µ–∑–¥–∫–∏
- ‚úÖ `journey_end_date` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–µ–∑–¥–∫–∏
- ‚úÖ `created_at` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
- ‚ö†Ô∏è `updated_at` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –∫–æ–¥–µ (–º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏)
- ‚ö†Ô∏è `phone_number` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ –±–æ—Ç–∞ (–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω–∫–µ)

**–¢–∞–±–ª–∏—Ü–∞ `locations`:**
- ‚úÖ `id` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- ‚úÖ `driver_id` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤—è–∑–∏ —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º
- ‚úÖ `latitude` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- ‚úÖ `longitude` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- ‚úÖ `created_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

**–¢–∞–±–ª–∏—Ü–∞ `journey_notifications`:**
- ‚úÖ `id` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
- ‚úÖ `driver_id` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤—è–∑–∏ —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º
- ‚úÖ `notification_type` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ `sent_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- ‚úÖ `created_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

**–¢–∞–±–ª–∏—Ü–∞ `users`:**
- ‚úÖ `timezone` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∞–¥–º–∏–Ω–∞
- ‚úÖ `role` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–æ–≤

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–µ–π

### ‚úÖ –í—Å–µ —Å–≤—è–∑–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

1. **drivers ‚Üí locations**
   - `locations.driver_id` ‚Üí `drivers.id`
   - ON DELETE CASCADE ‚úÖ
   - –ò–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω ‚úÖ

2. **drivers ‚Üí journey_notifications**
   - `journey_notifications.driver_id` ‚Üí `drivers.id`
   - ON DELETE CASCADE ‚úÖ
   - –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á: `fk_driver` ‚úÖ

3. **users ‚Üí auth.users**
   - `users.id` ‚Üí `auth.users.id`
   - –î–ª—è —Å–≤—è–∑–∏ —Å —Å–∏—Å—Ç–µ–º–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Supabase

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (CHECK constraints)

### ‚úÖ –í—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

1. **drivers.route_status**
   - CHECK: `route_status IN ('not-started-yet', 'in-progress', 'stopped')` ‚úÖ
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É –≤ `setDriverRouteStatus()`

2. **journey_notifications.notification_type**
   - CHECK: `notification_type IN ('ending_soon', 'ended')` ‚úÖ
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É –≤ `markJourneyNotificationSent()`

3. **users.role**
   - CHECK: `role IN ('admin', 'user')` ‚úÖ

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updated_at` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚ö†Ô∏è **–¢—Ä–∏–≥–≥–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `updated_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `drivers`.

–°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ:

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_drivers_updated_at 
  BEFORE UPDATE ON drivers 
  FOR EACH ROW 
  EXECUTE FUNCTION update_updated_at_column();
```

### 2. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
‚úÖ **–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∏–Ω–¥–µ–∫—Å–æ–≤ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã!**

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `drivers_pkey` - –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
- ‚úÖ `drivers_token_key` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ —Ç–æ–∫–µ–Ω
- ‚úÖ `idx_drivers_telegram_chat_id` - –∏–Ω–¥–µ–∫—Å –Ω–∞ telegram_chat_id
- ‚úÖ `idx_drivers_token` - –∏–Ω–¥–µ–∫—Å –Ω–∞ —Ç–æ–∫–µ–Ω
- ‚úÖ `idx_drivers_route_status` - –∏–Ω–¥–µ–∫—Å –Ω–∞ route_status
- ‚úÖ `idx_drivers_journey_end_date` - –∏–Ω–¥–µ–∫—Å –Ω–∞ journey_end_date
- ‚úÖ `idx_locations_driver_id` - –∏–Ω–¥–µ–∫—Å –Ω–∞ driver_id –≤ locations
- ‚úÖ `idx_locations_created_at` - –∏–Ω–¥–µ–∫—Å –Ω–∞ created_at –≤ locations
- ‚úÖ `idx_journey_notifications_driver_id` - –∏–Ω–¥–µ–∫—Å –Ω–∞ driver_id
- ‚úÖ `idx_journey_notifications_driver_type` - —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å
- ‚úÖ `idx_journey_notifications_type` - –∏–Ω–¥–µ–∫—Å –Ω–∞ notification_type

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
```sql
-- –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–∞–º –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–º–µ—Å—Ç–µ
CREATE INDEX IF NOT EXISTS idx_drivers_journey_dates 
  ON drivers(journey_start_date, journey_end_date) 
  WHERE journey_start_date IS NOT NULL OR journey_end_date IS NOT NULL;
```

### 3. RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
–¢–µ–∫—É—â–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ RLS —Ä–∞–∑—Ä–µ—à–∞—é—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏:

```sql
-- –î–ª—è locations: –≤–æ–¥–∏—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ª–æ–∫–∞—Ü–∏–∏
CREATE POLICY "Drivers can view their own locations" ON locations
  FOR SELECT
  USING (
    driver_id IN (
      SELECT id FROM drivers 
      WHERE telegram_chat_id = current_setting('app.telegram_chat_id', true)::bigint
    )
  );
```

### 4. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏
- `drivers.phone_number` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ –±–æ—Ç–∞, –Ω–æ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω–∫–µ
- `drivers.updated_at` - –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–¥–µ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä

## –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å–≤—è–∑–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ**
‚úÖ **–¢–∞–±–ª–∏—Ü–∞ `locations` —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–≤—è–∑–∞–Ω–∞ —Å `drivers`**
‚úÖ **–í—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –∫–æ–¥–µ –∫–æ–ª–æ–Ω–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ë–î**
‚úÖ **–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å CASCADE DELETE**
‚úÖ **CHECK constraints —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ª–æ–≥–∏–∫–µ –≤ –∫–æ–¥–µ**

‚ö†Ô∏è **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `updated_at` (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
- ‚úÖ –°–æ–∑–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç–µ–∫—É—â–∏–µ —Ä–∞–∑—Ä–µ—à–∞—é—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã
2. –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å CASCADE DELETE
3. –í—Å–µ CHECK constraints —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ª–æ–≥–∏–∫–µ –≤ –∫–æ–¥–µ
4. –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –∫–æ–¥–µ –∫–æ–ª–æ–Ω–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ë–î
5. –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
6. –¢–∞–±–ª–∏—Ü–∞ `locations` —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–≤—è–∑–∞–Ω–∞ —Å `drivers`

### ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:
1. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `updated_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `drivers`
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–∞–º –ø–æ–µ–∑–¥–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
- **–¢–∞–±–ª–∏—Ü –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:** 4 (drivers, locations, journey_notifications, users)
- **–ö–æ–ª–æ–Ω–æ–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:** 30+
- **–í–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π:** 2 (–≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
- **–ò–Ω–¥–µ–∫—Å–æ–≤:** 12 (–≤—Å–µ —Å–æ–∑–¥–∞–Ω—ã)
- **CHECK constraints:** 3 (–≤—Å–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∫–æ–¥—É)

